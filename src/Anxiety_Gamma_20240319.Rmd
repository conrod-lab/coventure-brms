---
title: "CoVenture Anxiety Outcomes 20 March 2024"
author: "Samantha J. Lynch"
output:  
  html_notebook:
    theme: paper
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.width = 7,
    tidy = TRUE
)

## turn off scientific notation 
options(scipen=999)
```

```{r libraries, options}
# Load libraries
library(tidyverse) #
library(haven)  # load and work with SPSS data files
library(summarytools) # for summary statistics
library(gtsummary) # for summary statistics
library(ggthemes)
library(lme4) #frequentist regression models
library(brms) # Bayesian Regression Models
library(StanHeaders) # need to laod this for brms
library(data.table) # wrangling and formatting data and tables
library(formattable)
library(broom)
library(finalfit)
library(knitr)
library(emmeans)
library(ggeffects)
library(tidybayes)
library(bayesplot)

## set theme
theme_gtsummary_journal(journal = "jama")
theme_gtsummary_compact()

```

# Anxiety 

## Gaussian 
```{r depression gaussian, options, echo=TRUE, results='asis'}
mod_anx_cont <- brm(ANX ~ 1 + DEM_01 + Exp_Group + Language + year + year:Exp_Group + (1|id+schoolnum),  
               data = cov_5, 
               family = gaussian,
               warmup = 1000, iter = 4000, 
               cores = 4, chains = 4, 
               seed = 123,
               control = list(adapt_delta = 0.9)) #increasing for better convergence     
```


### Results {.tabset}

#### Summary
```{r depression gaussian results summary, echo=FALSE}
summ_mod_anx_cont=summary(mod_anx_cont)
formattable(summ_mod_anx_cont$fixed)


```

#### Detailed
```{r depression gaussian results detailed, echo=FALSE}
summ_mod_anx_cont
```

### Model quality checks
#### Plot predicted data using posterior predictive checks
```{r Plot density of data vs model predicted data}
pp_check(mod_anx_cont)
```
#### Plot variables and traceplots

```{r traceplots}
plot(mod_anx_cont,
     variable = "^b_", regex = TRUE, # only plot population level
     plot = TRUE, ask = FALSE, newpage=FALSE) 
```
#### Plot predicted response for the different predicotrs
```{r conditional effects anx}
plot(conditional_effects(mod_anx_cont), plot = TRUE, ask = FALSE, newpage=FALSE)
```

## Gamma 
```{r anxiety gamma, echo=TRUE, results='hide'}
mod_anx_gamma <- brm(
  ANX ~ 1 + DEM_01 + Exp_Group + Language + year + year:Exp_Group + (1|id+schoolnum),
  data = cov_5,
  family = hurdle_gamma(link = "log"),
  warmup = 1000, iter = 4000,
  cores = 4, chains = 4,
  seed = 123,
  control = list(adapt_delta = 0.9) #changing to improve convergence
)
```
### Results {.tabset}
#### Summary
```{r anxiety gamma results summary}
summ_mod_anx_gamma=summary(mod_anx_gamma)
formattable(summ_mod_anx_gamma$fixed)
```
#### Detailed
```{r anxiety gamma results}
summ_mod_anx_gamma
```
### Model quality checks
#### Plot predicted data using posterior predictive checks
```{r Gamma Plot density of data vs model predicted data}
pp_check(mod_anx_gamma)
```



#### Plot variables and traceplots
```{r gamma traceplots}
plot(mod_anx_gamma,
     variable = "^b_", regex = TRUE, # only plot population level
     plot = TRUE, ask = FALSE, newpage=FALSE) 
```

#### Plot predicted response for the different predicotrs
```{r gamma conditional effects anx,fig.height=5}
plot(conditional_effects(mod_anx_gamma),plot = TRUE, ask = FALSE, newpage=FALSE)
```
## Poisson
```{r anxiety poisson, echo=TRUE, results='hide'}
mod_anx_pois <- brm(
  ANX ~ 1 + DEM_01 + Exp_Group + Language + year + year:Exp_Group + (1|id+schoolnum),
  data = cov_5,
  family = zero_inflated_poisson(link = "log", link_zi = "logit"),
  warmup = 1000, iter = 4000,
  cores = 4, chains = 4,
  seed = 123,
  control = list(adapt_delta = 0.9) #changing to improve convergence
)
```
#### Summary
```{r anxiety poisson results summary}
summ_mod_anx_pois=summary(mod_anx_pois)
formattable(summ_mod_anx_pois$fixed)
```

### Plot posterior predictive checks

```{r}
pp_check(mod_anx_pois)
```
### LOO comparing gamma and poisson models
- I think this suggests that the gamma model is better
```{r}

# Compute LOO for mod_anx_gamma
loo_gamma <- loo(mod_anx_gamma)

# Compute LOO for mod_anx_pois
loo_pois <- loo(mod_anx_pois)

# compare both models
loo_compare(loo_gamma, loo_pois)
```
 
### Confusion matrices
Threshold for comparing binary actual outcomes vs predicted: above or below mean anxiety (3.49)
Gamma seems slightly better at predicting who is below the mean on anxeity, but poisson seems slightly better at predicting who is above the mean
#### Gamma model
```{r gamma confusion matrix}
# Get predicted values from the model
predictions <- predict(mod_anx_gamma, type = "response")

# Define threshold for binary classification
threshold <- mean(cov_5$ANX,na.rm = TRUE)

# Convert predicted probabilities into binary predictions
binary_predictions <- ifelse(predictions > threshold, 1, 0)
binary_predictions <- as.vector(binary_predictions[,1])

# Obtain actual outcomes from the dataset
actual_outcomes <- cov_5$ANX  # Adjust according to your dataset
binary_actual_outcomes <- ifelse(actual_outcomes > threshold, 1, 0) 
# Remove NA values from actual_outcomes
binary_actual_outcomes <- na.omit(binary_actual_outcomes)

# Create confusion matrix
conf_matrix <- table(binary_actual_outcomes, binary_predictions)

# Display confusion matrix
print(conf_matrix)
```
#### Possoin model
```{r}
# Get predicted values from the model
predictions <- predict(mod_anx_pois, type = "response")

# Define threshold for binary classification
threshold <- mean(cov_5$ANX,na.rm = TRUE)

# Convert predicted probabilities into binary predictions
binary_predictions <- ifelse(predictions > threshold, 1, 0)
binary_predictions <- as.vector(binary_predictions[,1])

# Obtain actual outcomes from the dataset
actual_outcomes <- cov_5$ANX  # Adjust according to your dataset
binary_actual_outcomes <- ifelse(actual_outcomes > threshold, 1, 0) 
# Remove NA values from actual_outcomes
binary_actual_outcomes <- na.omit(binary_actual_outcomes)

# Create confusion matrix
conf_matrix <- table(binary_actual_outcomes, binary_predictions)

# Display confusion matrix
print(conf_matrix)
```

## Plots of raw data

```{r distribution anx, fig.height=5}
# Assuming 'cov_5' is your data frame and 'ANX' is the response variable
hist(cov_5$ANX, main = "Histogram of ANX", xlab = "ANX")

# Add a line at y = 0 for reference
abline(h = 0, col = "red")

# Add a vertical line at x = 0 for reference
abline(v = 0, col = "blue")
```

```{r boxplot anx, fig.height=5}
boxplot(cov_5$ANX, main = "Boxplot of ANX")
```
